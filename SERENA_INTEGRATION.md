# Serena MCP Integration Guide

**Date**: 2025-11-09
**Phase**: 1 - Serena Integration (Weeks 1-2)
**Status**: Implementation in Progress

---

## Overview

This document describes the integration of Serena MCP into the Claude Code command system as part of the hybrid approach to command independence.

**Serena MCP** provides:
- Semantic code analysis (symbol-level operations)
- Memory persistence system (.serena/memories/)
- Project knowledge management
- Workflow quality validation tools

**Integration Goal**: Use Serena as the backend for memory storage and semantic code operations while maintaining custom workflow orchestration.

---

## 1. MCP Configuration

### Location
`cc/.mcp.json`

### Configuration
```json
{
  "mcpServers": {
    "serena": {
      "command": "uvx",
      "args": [
        "--from",
        "git+https://github.com/oraios/serena",
        "serena",
        "start-mcp-server"
      ],
      "description": "Serena MCP - Semantic code retrieval and editing toolkit"
    }
  }
}
```

### Installation Requirements
```bash
# Install uv package manager (if not already installed)
# Serena will be automatically installed when first invoked
# via uvx --from git+https://github.com/oraios/serena
```

---

## 2. Memory Naming Conventions

### Session Memories

All session-related memories follow this naming pattern:

```
session_{SESSION_ID}_{PHASE}.md
```

**Examples**:
```
session_20251109_143022_a1b2c3d4_explore.md
session_20251109_143022_a1b2c3d4_plan.md
session_20251109_143022_a1b2c3d4_code.md
session_20251109_143022_a1b2c3d4_meta.md
```

### Session Metadata Memory

Each session has a metadata memory stored as JSON:

```markdown
<!-- session_20251109_143022_a1b2c3d4_meta.md -->
```json
{
  "sessionId": "20251109_143022_a1b2c3d4",
  "description": "Add OAuth authentication",
  "state": "PLANNING",
  "created": "2025-11-09T14:30:22Z",
  "updated": "2025-11-09T14:35:10Z",
  "phases": {
    "explore": {
      "status": "completed",
      "timestamp": "2025-11-09T14:30:22Z",
      "memoryName": "session_20251109_143022_a1b2c3d4_explore"
    },
    "plan": {
      "status": "in_progress",
      "timestamp": "2025-11-09T14:35:10Z",
      "memoryName": "session_20251109_143022_a1b2c3d4_plan"
    },
    "code": {
      "status": "pending"
    }
  }
}
```
```

### Knowledge Memories

Reusable knowledge (not session-specific):

```
knowledge_{TOPIC}.md
```

**Examples**:
```
knowledge_authentication.md
knowledge_api_patterns.md
knowledge_testing_strategy.md
```

### Task Memories

Standalone task tracking (outside session workflow):

```
task_{TASK_NAME}.md
```

**Examples**:
```
task_oauth_investigation.md
task_refactor_auth_module.md
```

### Archived Sessions

Completed or archived sessions:

```
archived_session_{SESSION_ID}_{PHASE}.md
```

**Examples**:
```
archived_session_20251101_120000_xyz_explore.md
archived_session_20251101_120000_xyz_plan.md
archived_session_20251101_120000_xyz_code.md
archived_session_20251101_120000_xyz_meta.md
```

### Project Memories

Auto-generated by Serena (do not modify manually):

```
onboarding.md
```

---

## 3. Available Serena Tools

### Memory Operations

All commands now have access to:

```
mcp__serena__write_memory
‚îú‚îÄ Usage: Save session results, knowledge, or task state
‚îú‚îÄ Format: Markdown content
‚îî‚îÄ Example: write_memory("session_123_explore", "$RESULTS")

mcp__serena__read_memory
‚îú‚îÄ Usage: Load previous session results or knowledge
‚îî‚îÄ Example: read_memory("session_123_explore")

mcp__serena__list_memories
‚îú‚îÄ Usage: List all available memories
‚îî‚îÄ Example: list_memories()

mcp__serena__delete_memory
‚îú‚îÄ Usage: Clean up old memories
‚îî‚îÄ Example: delete_memory("session_old_explore")
```

### Semantic Code Operations

```
mcp__serena__find_symbol
‚îú‚îÄ Usage: Search for symbols by name (functions, classes, etc.)
‚îú‚îÄ Filters: By symbol type
‚îî‚îÄ Example: find_symbol("Authentication")

mcp__serena__find_referencing_symbols
‚îú‚îÄ Usage: Find symbols that reference a given symbol
‚îî‚îÄ Example: find_referencing_symbols("login_function")

mcp__serena__find_referencing_code_snippets
‚îú‚îÄ Usage: Find code snippets where symbol is used
‚îî‚îÄ Example: find_referencing_code_snippets("login_function")

mcp__serena__get_symbols_overview
‚îú‚îÄ Usage: Get structure of file or directory
‚îî‚îÄ Example: get_symbols_overview("src/auth/")

mcp__serena__search_for_pattern
‚îú‚îÄ Usage: Regex pattern search
‚îî‚îÄ Example: search_for_pattern("import.*OAuth")
```

### Code Editing

```
mcp__serena__insert_after_symbol
‚îú‚îÄ Usage: Insert code after a symbol definition
‚îî‚îÄ Example: insert_after_symbol("AuthClass", "$NEW_METHOD")

mcp__serena__insert_before_symbol
‚îú‚îÄ Usage: Insert code before a symbol
‚îî‚îÄ Example: insert_before_symbol("login", "$DECORATOR")

mcp__serena__replace_symbol_body
‚îú‚îÄ Usage: Replace implementation of a symbol
‚îî‚îÄ Example: replace_symbol_body("old_function", "$NEW_IMPL")
```

### Workflow Quality Tools

```
mcp__serena__think_about_task_adherence
‚îú‚îÄ Usage: Verify staying on track with current task
‚îî‚îÄ Example: Use before saving phase results

mcp__serena__think_about_collected_information
‚îú‚îÄ Usage: Evaluate completeness of gathered info
‚îî‚îÄ Example: Use in explore phase before proceeding

mcp__serena__think_about_whether_you_are_done
‚îú‚îÄ Usage: Determine if task is truly complete
‚îî‚îÄ Example: Use in code phase before marking complete

mcp__serena__summarize_changes
‚îú‚îÄ Usage: Create summary of code changes
‚îî‚îÄ Example: Use at end of code phase
```

### Project Management

```
mcp__serena__get_active_project
‚îú‚îÄ Usage: Get current project name
‚îî‚îÄ Example: get_active_project()

mcp__serena__check_onboarding_performed
‚îú‚îÄ Usage: Check if Serena has learned the codebase
‚îî‚îÄ Example: check_onboarding_performed()
```

---

## 4. Command Integration Patterns

### Explore Command Pattern

```bash
# 1. Check if project is onboarded
check_onboarding_performed

# 2. If onboarded, read project knowledge
if onboarded; then
  read_memory("onboarding")
fi

# 3. Use semantic search instead of grep
find_symbol("relevant_code")
get_symbols_overview("target_directory")

# 4. Save results to session memory
write_memory("session_${SESSION_ID}_explore", "$EXPLORATION_RESULTS")

# 5. Update session metadata
write_memory("session_${SESSION_ID}_meta", "$SESSION_METADATA_JSON")
```

### Plan Command Pattern

```bash
# 1. Load exploration context
EXPLORE_CONTEXT=$(read_memory("session_${SESSION_ID}_explore") || echo "")

# 2. If no exploration, use standalone mode with onboarding
if [ -z "$EXPLORE_CONTEXT" ]; then
  read_memory("onboarding")
fi

# 3. Create plan with context
# ... planning logic ...

# 4. Validate plan adherence
think_about_task_adherence

# 5. Save plan
write_memory("session_${SESSION_ID}_plan", "$PLAN_RESULTS")

# 6. Update session metadata
write_memory("session_${SESSION_ID}_meta", "$UPDATED_METADATA")
```

### Code Command Pattern

```bash
# 1. Load plan context
PLAN_CONTEXT=$(read_memory("session_${SESSION_ID}_plan") || echo "")

# 2. Use semantic code operations
find_symbol("target_function")
insert_after_symbol("TargetClass", "$NEW_METHOD")

# 3. Check completion before finishing
think_about_whether_you_are_done

# 4. Summarize changes
SUMMARY=$(summarize_changes)

# 5. Save implementation results
write_memory("session_${SESSION_ID}_code", "$IMPLEMENTATION_RESULTS\n\n$SUMMARY")

# 6. Update session metadata
write_memory("session_${SESSION_ID}_meta", "$COMPLETED_METADATA")
```

---

## 5. Tool Naming Convention

All Serena tools are prefixed with `mcp__serena__`:

```
Original Serena Tool    ‚Üí    Claude Code Tool Name
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
find_symbol             ‚Üí    mcp__serena__find_symbol
write_memory            ‚Üí    mcp__serena__write_memory
read_memory             ‚Üí    mcp__serena__read_memory
```

**Why**: MCP tools are automatically prefixed to avoid naming conflicts.

---

## 6. Integration Benefits

### Before Serena Integration

```bash
# explore.md had to:
grep -r "authentication" src/          # Text-based search
cat src/auth/login.py | head -50       # Read full files
# Manual file management for session data
echo "$RESULTS" > .claude/sessions/.../explore.md
```

### After Serena Integration

```bash
# explore.md can now:
find_symbol("Authentication")           # Semantic search
get_symbols_overview("src/auth/")      # Structure analysis
write_memory("session_${ID}_explore", "$RESULTS")  # Managed persistence
```

**Improvements**:
- ‚úÖ Symbol-level precision (no full file reads)
- ‚úÖ Language-aware searching
- ‚úÖ Built-in memory management
- ‚úÖ Project knowledge reuse
- ‚úÖ Quality validation tools

---

## 7. Fallback Strategy

### Abstraction Principle

Commands should never directly depend on Serena. Always use abstraction:

```bash
# Good: Fallback support
if command -v mcp__serena__find_symbol &> /dev/null; then
  find_symbol("Authentication")
else
  grep -r "Authentication" src/
fi

# Bad: Hard dependency
find_symbol("Authentication")  # Fails if Serena unavailable
```

### Feature Flags

Future implementation will include:

```yaml
# .claude/config.yaml
features:
  serena_memory: true           # Use Serena for memory backend
  serena_semantic_ops: true     # Use Serena for code operations
  serena_thinking_tools: true   # Use Serena validation tools
  serena_fallback: true         # Fall back to basic tools if Serena fails
```

---

## 8. Testing Checklist

### Memory Operations
- [ ] write_memory creates file in .serena/memories/
- [ ] read_memory retrieves content correctly
- [ ] list_memories shows all memories
- [ ] delete_memory removes memory

### Semantic Search
- [ ] find_symbol locates code symbols
- [ ] get_symbols_overview shows structure
- [ ] search_for_pattern finds regex matches

### Code Editing
- [ ] insert_after_symbol works correctly
- [ ] replace_symbol_body updates code

### Workflow Tools
- [ ] think_about_task_adherence validates alignment
- [ ] think_about_collected_information checks completeness
- [ ] think_about_whether_you_are_done validates completion

### Project Setup
- [ ] check_onboarding_performed returns status
- [ ] Onboarding creates onboarding.md memory
- [ ] get_active_project returns project info

---

## 9. Migration Path

### Phase 1 (Current)
- ‚úÖ Install Serena MCP configuration
- ‚úÖ Document memory conventions
- üîÑ Update command allowed-tools
- üîÑ Add Serena tool usage examples
- ‚è≥ Test integration

### Phase 2 (Next)
- Build session manager using Serena backend
- Implement state machine
- Update commands to use hybrid approach

### Phase 3
- Add standalone command modes
- Implement quality validation
- Create session management CLI

---

## 10. Known Limitations

### Serena Limitations
- Single active project at a time (use project switching)
- Language server startup can be slow for Java
- Requires `uv` package manager installed

### Integration Limitations
- MCP tool names are verbose (mcp__serena__*)
- Serena must be running for commands to use features
- First-time onboarding takes time for large codebases

### Workarounds
- Use feature flags to disable Serena if needed
- Implement fallbacks to basic tools
- Cache onboarding results

---

## 11. Troubleshooting

### Serena Not Starting
```bash
# Check if uv is installed
which uv

# Install uv if missing
curl -LsSf https://astral.sh/uv/install.sh | sh

# Manually test Serena
uvx --from git+https://github.com/oraios/serena serena start-mcp-server
```

### Memory Not Found
```bash
# List all memories
list_memories()

# Check .serena directory exists
ls -la .serena/memories/

# Verify memory naming convention
# Should be: session_{ID}_{phase}.md
```

### Semantic Search Not Working
```bash
# Check if language server is running
get_active_project()

# Restart language server if needed
restart_language_server()

# Run onboarding if project is new
check_onboarding_performed()
```

---

## 12. Best Practices

### Memory Management
1. **Always use consistent naming**: Follow session_{ID}_{phase} pattern
2. **Update metadata**: Keep session_*_meta.md in sync
3. **Clean up old sessions**: Use delete_memory for archived sessions
4. **Separate concerns**: Use knowledge_* for reusable info

### Semantic Operations
1. **Start with onboarding**: Check project knowledge first
2. **Use symbols over text**: Prefer find_symbol over grep
3. **Validate results**: Use thinking tools before completion
4. **Summarize changes**: Always document what was modified

### Quality Control
1. **Check task adherence**: Use think_about_task_adherence regularly
2. **Validate completeness**: Use think_about_collected_information
3. **Confirm completion**: Use think_about_whether_you_are_done
4. **Document changes**: Use summarize_changes at end

---

## 13. Next Steps

### Immediate (Phase 1)
- [x] Create .mcp.json configuration
- [x] Document memory conventions
- [ ] Update explore.md with Serena tools
- [ ] Update plan.md with Serena tools
- [ ] Update code.md with Serena tools
- [ ] Test Serena integration
- [ ] Create example workflows

### Upcoming (Phase 2)
- [ ] Build SessionManager using Serena backend
- [ ] Implement state machine
- [ ] Create session metadata schema
- [ ] Update commands to use hybrid approach

---

**Status**: Phase 1 In Progress
**Last Updated**: 2025-11-09
**Next Milestone**: Command updates and testing
